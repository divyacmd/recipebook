<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for RecipeBook-Backend-API/routes/users.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="..\..\prettify.css" />
    <link rel="stylesheet" href="..\..\base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(..\..\sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="..\..\index.html">All files</a> / <a href="index.html">RecipeBook-Backend-API/routes</a> users.js
    </h1>
    <div class='clearfix'>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</td><td class="line-coverage quiet"><span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span></td><td class="text"><pre class="prettyprint lang-js">const auth = require("../middleware/auth");
//const config = require('config');
const bcrypt = require("bcrypt");
const crypto = require('crypto');
const moment = require('moment');
const _ = require("lodash");
const nodemailer = require('nodemailer');
const { User, validate } = require("../models/user");
const { ResetPassword } = require("../models/resetPassword");
const express = require("express");
const router = express.Router();
&nbsp;
&nbsp;
router.get("/me", auth, <span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
    const user = <span class="cstat-no" title="statement not covered" >await User.findById(req.user._id).select("-password");</span>
<span class="cstat-no" title="statement not covered" >    res.send(user);</span>
});
&nbsp;
&nbsp;
router.post("/", <span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
    // Limit the registration to N users
    //const max_users = config.get("maxUsers")
    const max_users = <span class="cstat-no" title="statement not covered" >process.env.RECIPE_API_MAX_USERS || 1000;</span>
    const user_count = <span class="cstat-no" title="statement not covered" >await User.countDocuments({})</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (user_count &gt;= max_users*1) <span class="cstat-no" title="statement not covered" >return res.status(403).send("Max users limit crossed")</span></span>
&nbsp;
    const { error } = <span class="cstat-no" title="statement not covered" >validate(req.body);</span>
<span class="cstat-no" title="statement not covered" >    if (error) <span class="cstat-no" title="statement not covered" >return res.status(400).send(error.details[0].message);</span></span>
&nbsp;
    let user = <span class="cstat-no" title="statement not covered" >await User.findOne({ email: req.body.email });</span>
<span class="cstat-no" title="statement not covered" >    if (user) <span class="cstat-no" title="statement not covered" >return res.status(400).send("User already registered.");</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    user = new User(_.pick(req.body, ["name", "email", "password"]));</span>
    const salt = <span class="cstat-no" title="statement not covered" >await bcrypt.genSalt(10);</span>
<span class="cstat-no" title="statement not covered" >    user.password = await bcrypt.hash(user.password, salt);</span>
<span class="cstat-no" title="statement not covered" >    await user.save();</span>
&nbsp;
    const token = <span class="cstat-no" title="statement not covered" >user.generateAuthToken();</span>
<span class="cstat-no" title="statement not covered" >    res</span>
        .header("x-auth-token", token)
        .send(_.pick(user, ["_id", "name", "email"]));
});
&nbsp;
&nbsp;
&nbsp;
&nbsp;
router.post('/resetPassword', <span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
    const email = <span class="cstat-no" title="statement not covered" >req.body.email;</span>
    
    let user = <span class="cstat-no" title="statement not covered" >await User.findOne({ email })</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!user) {</span>
<span class="cstat-no" title="statement not covered" >        return res.status(404).send("No user with that email address")</span>
    }
           
    const resetPassword = <span class="cstat-no" title="statement not covered" >await ResetPassword.findOne({ userId: user.id })</span>
<span class="cstat-no" title="statement not covered" >    if (resetPassword) {</span>
<span class="cstat-no" title="statement not covered" >        await ResetPassword.findByIdAndRemove(resetPassword._id)</span>
    }
&nbsp;
    const token = <span class="cstat-no" title="statement not covered" >await crypto.randomBytes(32).toString('hex')</span>
    const salt = <span class="cstat-no" title="statement not covered" >await bcrypt.genSalt(10); </span>
&nbsp;
    const hash = <span class="cstat-no" title="statement not covered" >await bcrypt.hash(token, salt)              </span>
            
<span class="cstat-no" title="statement not covered" >    await ResetPassword.create({</span>
        userId: user.id,
        resetPasswordToken: hash,
        expire: moment.utc().add(/*config.tokenExpiry*/process.env.RECIPE_API_TOKEN_EXPIRY, 'seconds'),
   })
&nbsp;
    const transporter = <span class="cstat-no" title="statement not covered" >nodemailer.createTransport({</span>
        service: 'gmail',
        auth: {
            // user: config.email,
            // pass: config.mailPassword
            user: process.env.RECIPE_API_EMAIL,
            pass: process.env.RECIPE_API_MAIL_PASSWORD
        }
    });
&nbsp;
    let mailOptions = <span class="cstat-no" title="statement not covered" >{</span>
        from: "+&lt;RecipeBook&gt;",
        to: user.email,
        subject: 'Reset your account password',
        html: '&lt;h2&gt;RecipeBook&lt;/h2&gt;' +
        '&lt;h4&gt;&lt;b&gt;Reset Password&lt;/b&gt;&lt;/h4&gt;' +
        '&lt;p&gt;Click this link to reset your password:&lt;/p&gt;' +
        //'&lt;a href=http://' + config.clientUrl + 'reset/' + user.id + '/' + token + '"&gt;' + config.clientUrl + 'reset/' + user.id + '/' + token + '&lt;/a&gt;' +
        '&lt;a href=http://' + process.env.RECIPE_API_CLIENT_URL + 'reset/' + user.id + '/' + token + '"&gt;' + process.env.RECIPE_API_CLIENT_URL + 'reset/' + user.id + '/' + token + '&lt;/a&gt;' +
        '&lt;br&gt;&lt;br&gt;' +
        '&lt;p&gt;-- Thanks&lt;/p&gt;'
    }
                       
    let mailSent = <span class="cstat-no" title="statement not covered" >await transporter.sendMail(mailOptions)</span>
        
<span class="cstat-no" title="statement not covered" >    if (mailSent) {</span>
<span class="cstat-no" title="statement not covered" >        return res.send('Check your mail to reset your password.')</span>
    } 
    else {
<span class="cstat-no" title="statement not covered" >        return res.status(503).send('Unable to send email.');</span>
    }
})
     
&nbsp;
&nbsp;
&nbsp;
router.post('/storePassword', <span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
    const userId = <span class="cstat-no" title="statement not covered" >req.body.userId</span>
    const token = <span class="cstat-no" title="statement not covered" >req.body.token</span>
    const password = <span class="cstat-no" title="statement not covered" >req.body.password</span>
    
    const resetPassword = <span class="cstat-no" title="statement not covered" >await ResetPassword.findOne({ userId })    </span>
<span class="cstat-no" title="statement not covered" >    if (!resetPassword) {</span>
<span class="cstat-no" title="statement not covered" >        return res.status(404).send('Invalid or expired reset token.')</span>
    }
    
    const match = <span class="cstat-no" title="statement not covered" >await bcrypt.compare(token, resetPassword.resetPasswordToken) </span>//, function (errBcrypt, resBcrypt) {// the token and the hashed token in the db are verified befor updating the password
    
    //const match = token.toString() === resetPassword.resetPasswordToken.toString();
<span class="cstat-no" title="statement not covered" >    if (!match) {</span>
<span class="cstat-no" title="statement not covered" >        return res.status(404).send('Invalid or expired reset token.')</span>
    }
&nbsp;
    let expireTime = <span class="cstat-no" title="statement not covered" >moment.utc(resetPassword.expire)</span>
    let currentTime = <span class="cstat-no" title="statement not covered" >new Date();</span>
    
    const salt = <span class="cstat-no" title="statement not covered" >await bcrypt.genSalt(10); </span>
    const hash = <span class="cstat-no" title="statement not covered" >await bcrypt.hash( password.toString(), salt)  </span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    await User.findByIdAndUpdate(</span>
        {_id: userId},
        { password: hash },
<span class="fstat-no" title="function not covered" >        fu</span>nction(err, result) {
<span class="cstat-no" title="statement not covered" >            if (err) <span class="cstat-no" title="statement not covered" >res.send(err);</span></span>
           //else res.send(result);
        }
    )
<span class="cstat-no" title="statement not covered" >    await ResetPassword.findByIdAndRemove(resetPassword._id) </span>
        
<span class="cstat-no" title="statement not covered" >    res.send("Successfully reset")</span>
})
&nbsp;
&nbsp;
module.exports = router;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Fri Feb 25 2022 16:13:12 GMT+0545 (Nepal Time)
</div>
</div>
<script src="..\..\prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="..\..\sorter.js"></script>
</body>
</html>
